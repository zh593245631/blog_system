<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>博客管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="css/base.css" rel="stylesheet">
<link rel="stylesheet" href="editor.md/css/editormd.css" />
<script src="js/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="js/comm.js"></script>
<!--[if lt IE 9]>
<script src="js/modernizr.js"></script>
<![endif]-->
<style>
  [v-cloak]{
      display:none;
  }
</style>
</head>
<body>
<header>
  <div class="profile">
    <div class="avatar fl"><img src="images/avatar.jpg"></div>
    <div class="guanzhu fl">
      <ul>
        <li><img src="images/nianling.png"><span>生日：1998-05-19</span></li>
        <li><img src="images/weizhi.png"><span>中国·西安</span></li>
        <li><img src="images/qq.png"><span>QQ：1979749784</span></li>
        <li><img src="images/weixin.png"><span><img src="images/wxewm.jpg"></span></li>
      </ul>
    </div>
  </div>
</header>
<div id = "app">
<article v-cloak v-show="blog.blog_id == null">
  <main class="r_box">
    <div class="blogbox">
      <ul>
        <li> <i class="feed-avatar"><img src="images/avatar.jpg"></i>
          <!--插值表达式-->
          <h2><a href="/"> {{author}} 个人博客，属于我的小世界！</a></h2>
          <p class="feed-info">天下大事，必作于细</p>
        </li>
      </ul>
    </div>
        <div class="bloglist" v-for = "blog in blogs">
      <li>
        <!--v-on:click把当前的html 标签关联上一个鼠标点击事件-->
        <h3><a v-on:click="edit_blog(blog.blog_id)" target="_blank">{{blog.title}}</a></h3>
        <p class="feed-date">
          <span class="fd01">@{{author}}</span>
          <span class="fd01"><a href="/">{{blog.create_time}}</a></span>
          <span class="fd01">{{tag_id2name(blog.tag_id)}}</span>
          <span v-on:click="delete_blog(blog.blog_id)">删除</span>
        </p>
      </li>
      </div>
  </main>
  <aside class="l_box">
    <div class="wdxc">
      <h2>标签</h2>
      <ul>
        <li v-for="tag in tags"><a href="#">{{tag.tag_name}}</a></li>
      </ul>
    </div>
    <div class="search">
      <form action="/tuseday/e/search/index.php" method="post" name="searchform" id="searchform">
        <input name="keyboard" id="keyboard" class="input_text" value="请输入关键字词" style="color: rgb(153, 153, 153);" onfocus="if(value=='请输入关键字词'){this.style.color='#000';value=''}" onblur="if(value==''){this.style.color='#999';value='请输入关键字词'}" type="text">
        <input name="show" value="title" type="hidden">
        <input name="tempid" value="1" type="hidden">
        <input name="tbname" value="news" type="hidden">
        <input name="Submit" class="input_submit" value="搜索" type="submit">
      </form>
    </div>
    <div class="tuijian">
      <h2>最近更新</h2>
      <ul>
        <li><a href="/tuseday/diary/8.html" title="个人博客，属于我的小世界！">个人博客，属于我的小世界！</a></li>
        <li><a href="/tuseday/diary/19.html" title="一个三十而立的男程序员真实讲述：代码搅乱我的生活">一个三十而立的男程序员真实讲述：代码搅乱我的生活</a></li>
        <li><a href="/tuseday/diary/1.html" title="《寻之旅》一个关于旅游，游记的个人博客">《寻之旅》一个关于旅游，游记的个人博客</a></li>
        <li><a href="/tuseday/diary/16.html" title="个人博客从简不繁">个人博客从简不繁</a></li>
        <li><a href="/tuseday/diary/17.html" title="抄袭门过后——丢掉心结，重拾自己">抄袭门过后——丢掉心结，重拾自己</a></li>
        <li><a href="/tuseday/diary/12.html" title="个人博客，我为什么要用帝国cms？">个人博客，我为什么要用帝国cms？</a></li>
        <li><a href="/tuseday/photo/21.html" title="古典个人博客模板《青砖屋檐》">古典个人博客模板《青砖屋檐》</a></li>
        <li><a href="/tuseday/photo/7.html" title="简单手工纸玫瑰">简单手工纸玫瑰</a></li>
      </ul>
    </div>
    <div class="tuijian">
      <h2>点击排行</h2>
      <ul>
        <li><a href="/tuseday/diary/8.html" title="个人博客，属于我的小世界！">个人博客，属于我的小世界！</a></li>
        <li><a href="/tuseday/diary/19.html" title="一个三十而立的男程序员真实讲述：代码搅乱我的生活">一个三十而立的男程序员真实讲述：代码搅乱我的生活</a></li>
        <li><a href="/tuseday/diary/1.html" title="《寻之旅》一个关于旅游，游记的个人博客">《寻之旅》一个关于旅游，游记的个人博客</a></li>
        <li><a href="/tuseday/diary/16.html" title="个人博客从简不繁">个人博客从简不繁</a></li>
        <li><a href="/tuseday/diary/17.html" title="抄袭门过后——丢掉心结，重拾自己">抄袭门过后——丢掉心结，重拾自己</a></li>
        <li><a href="/tuseday/diary/12.html" title="个人博客，我为什么要用帝国cms？">个人博客，我为什么要用帝国cms？</a></li>
        <li><a href="/tuseday/photo/21.html" title="古典个人博客模板《青砖屋檐》">古典个人博客模板《青砖屋檐》</a></li>
        <li><a href="/tuseday/photo/7.html" title="简单手工纸玫瑰">简单手工纸玫瑰</a></li>
      </ul>
    </div>
    <div class="fenlei">
      <h2>分类</h2>
      <ul>
        <li><a href="/">新鲜事儿（13）</a></li>
        <li><a href="/">我的日记（8）</a></li>
        <li><a href="/">我的相册（8）</a></li>
        <li><a href="/">微记录（8）</a></li>
        <li><a href="/">视频（8）</a></li>
      </ul>
    </div>
    <div class="links">
      <h2>友情链接</h2>
      <ul>
        <li><a href="http://www.yangqq.com" title="{{author}}个人博客">{{author}}个人博客</a></li>
      </ul>
    </div>
  </aside>
</article>
<div  v-show = "blog.blog_id != null" v-cloak>
<article id="blog_view">
    <textarea>{{blog.content}}</textarea>
</article>
<button v-on:click="update_blog(blog.blog_id)">发表</button>
<button v-on:click="back()">返回</button>
</div>
<div class="blank"></div>
<footer>
  <p>Design by <a href="#" target="_blank">{{author}}个人博客</a></p>
</footer>
</div>
<a href="#" class="cd-top">Top</a>
<!-- 开发环境版本，包含了有帮助的命令行警告 -->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.6/dist/vue.js"></script>
<script src="editor.md/lib/marked.min.js"></script>
<script src="editor.md/lib/prettify.min.js"></script>

<script src="editor.md/lib/raphael.min.js"></script>
<script src="editor.md/lib/underscore.min.js"></script>
<script src="editor.md/lib/sequence-diagram.min.js"></script>
<script src="editor.md/lib/flowchart.min.js"></script>
<script src="editor.md/lib/jquery.flowchart.min.js"></script>

<script src="editor.md/editormd.js"></script>

<script>
var app = new Vue({
  el: '#app', //el 表示 app 这个vue 对象和哪个HTML关联
  data:{
    //data 表示所有需要在页面上动态变化的数据
   author: 'kc',
   blogs:[
   ],
   tags:[
   ],
   blog:{
     blog_id: null,
     title: null,
     content: null,
     create_time: null,
     tag_id: null,
   }
  },
   methods:{
     tag_id2name(tag_id){
        for(var index in this.tags){
          if(this.tags[index].tag_id == tag_id){
            return this.tags[index].tag_name;
          }
        }
        return "";
     },
     get_blogs(tag_id){
          var url = '/blog';
          if(tag_id != null){
            url = '/blog/?tag_id' + tag_id;
          }
          // 最核心操作， 访问 http 服务器的数据
          //JQuery
          $.ajax({
            url: url,
            type: "get",
            context:this,
            success: function(data, status){
                //HTTP 请求成功之后需要执行这个代码
                this.blogs = data;
            }
          })
     },
     init(){
       //1.从服务器上获取 tag
       $.ajax({
         type: "get",
         url: "/tag",
         context: this,
         success: function(data, status){
           this.tags = data;
           this.get_blogs();
         }
       })
     },
     get_blog(blog_id){
       $.ajax({
         url: '/blog/' + blog_id,
         type:"get",
         context: this,
         success: function(data,status){
           //获取markdown数据
           this.blog = data;
           //markdown 转html
           testEditormdView = editormd.markdownToHTML("blog_view", {
                        markdown        : this.blog.content ,//+ "\r\n" + $("#append-test").text(),
                        //htmlDecode      : true,       // 开启 HTML 标签解析，为了安全性，默认不开启
                        htmlDecode      : "style,script,iframe",  // you can filter tags decode
                        //toc             : false,
                        tocm            : true,    // Using [TOCM]
                        //tocContainer    : "#custom-toc-container", // 自定义 ToC 容器层
                        //gfm             : false,
                        //tocDropdown     : true,
                        // markdownSourceCode : true, // 是否保留 Markdown 源码，即是否删除保存源码的 Textarea 标签
                        emoji           : true,
                        taskList        : true,
                        tex             : true,  // 默认不解析
                        flowChart       : true,  // 默认不解析
                        sequenceDiagram : true,  // 默认不解析
                    });


         }
       })
     },
     delete_blog(blog_id){
       $.ajax({
         type: "delete",
         url: '/blog/' + blog_id,
         context: this,
         success: function(data, status){
           this.get_blogs();
           alert("删除成功");
         }
       })
   },
   
   edit_blog(blog_id){
     this.blog = {};
     $.ajax({
       type: "get",
       url: "/blog/" + blog_id,
       context:this,
       success:function(data, status){
         this.blog = data;
         testEditor = editormd("blog_view", {
                    width   : "90%",
                    height  : "720px",
                    syncScrolling : "single",
                    path    : "editor.md/lib/"
                });
       }
     })
   },
   back()
   {
     this.blog = {};
   },
   update_blog(blog_id)
   {
     var content = testEditor.getMarkdown();
     var body = {
          title: this.blog.title,
          content:content,
          tag_id:this.blog.tag_id
     }
     $.ajax({
       type: "put",
       url:"/blog/" + blog_id,
       data: JSON.stringify(body),
       contentType: 'application/json; charset=utf-8',
       context:this,
       success: function(data, status){
         this.get_blogs();
         alert("提交成功");
         this.back();
       }
     })
   }
   }
});
//初始化
app.init();
</script>
</body>
</html>
